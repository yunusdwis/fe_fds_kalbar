<!DOCTYPE html>
<html>

<head>
    <title>Fraud Management System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/bulma.min.css" />
    <link rel="stylesheet" href="css/fontawesome/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
    <script src="js/jquery.min.js"></script>
    <script src="js/util.js"></script>

    <style>
        html,
        body {
            height: 100%;
        }

        .tag {
            width: 100px;
        }

        .container-param {
            height: 70vh;
            font-size: 14px;
            overflow-x: auto;
        }
    </style>

</head>

<body>

    <div id="modal-edit-parameter" class="modal">
        <div class="modal-background"></div>
        <div class="modal-content" style="width:640px">
            <header class="modal-card-head fds-background-dark">
                <p class="modal-card-title has-text-white">Edit Parameter</p>
                <button class="modal_close delete is-large" aria-label="close"></button>
            </header>
            <div class="modal-card-body">
                <div class="content">
                    <div class="container">
                        <fieldset disabled>
                            <div class="field">
                                <p class="control">
                                    <label>Parameter Name</label>
                                    <input id="param_name" class="input " type="text" placeholder="Parameter Name">
                                </p>
                            </div>
                        </fieldset>
                        <div class="field">
                            <p class="control">
                                <label>Parameter Value</label>
                                <textarea id="param_value" class="textarea" placeholder="Value"></textarea>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="modal-card-foot">
                <button id="button_save_parameter" class="button is-success"><span class="icon is-small"><i
                            class="fas fa-check"></i></span><span>Save</span></button>
                <button class="button is-danger modal_close"><span class="icon is-small"><i
                            class="fas fa-times"></i></span><span>Cancel</span></button>
            </footer>
        </div>
    </div>

    <div class="columns m-0">
        <div id="sidemenu" class="column is-narrow fds-sidemenu" style="width: 250px;">
        </div>
        <div class="column m-1" style="background-color: #f4fbff;">
            <p class="panel-heading has-text-white" style="background: #054468">System Parameters</p>

            <div class="container-param mb-4">
                <table id="table-parameter-system" class="table is-striped is-fullwidth"
                    style="background: rgba(255,255,255,0);">
                    <thead>
                        <tr>
                            <th>Parameter Name</th>
                            <th>Value</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                </table>
            </div>
            <p class="panel-heading has-text-white" style="background: #054468">Transaction Parameters</p>
            <div class="container-param mb-4">
                <table id="table-parameter-transaction" class="table is-fullwidth"
                    style="background: rgba(255,255,255,0);">
                    <thead>
                        <tr>
                            <th>Parameter Name</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                </table>
            </div>

            <p class="panel-heading has-text-white" style="background: #054468">Opcode</p>
            <div class="container-param mb-4" style="height:250px">
                <!-- <div>
                    <input type="file" id="file-input-opcode" style="display: none">
                    <button class="button fds-background-dark mt-4 mb-4" id="upload-button-opcode">
                        <i class="fas fa-upload mr-2"></i>
                        Opcode
                    </button>
                </div> -->
                <table id="table-opcode" class="table is-fullwidth" style="background: rgba(255,255,255,0);">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Type</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <div style="width: 100%; margin-right: 10px;">

                    <p class="panel-heading has-text-white" style="background: #054468">Fraud Level</p>
                    <div class="container-param mb-4" style="height:250px">
                        <table id="table-level" class="table is-fullwidth" style="background: rgba(255,255,255,0);">
                            <thead>
                                <tr>
                                    <th>Fraud Level</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><span class="tag is-success">normal</span></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td><span class="tag is-warning is-light">normal</span></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td><span class="tag is-warning">medium</span></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td><span class="tag is-danger">medium</span></td>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                </div>
                <div style="width: 100%;">
                    <p class="panel-heading has-text-white" style="background: #054468">Action on Fraud</p>
                    <div class="container-param mb-4" style="height:250px">
                        <table id="table-action" class="table is-fullwidth" style="background: rgba(255,255,255,0);">
                            <thead>
                                <tr>
                                    <th>Action</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>flag</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>block</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>alert_customer_email</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>alert_customer_sms</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>alert_customer_whatsapp</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>alert_officer_email</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>alert_officer_sms</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>alert_officer_whatsapp</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>add_to_watchlist</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>add_to_blacklist</td>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between;">
                <div style="width: 100%; margin-right: 10px;">
                    <p class="panel-heading has-text-white" style="background: #054468">Watchlist Account</p>
                    <div class="container-param mb-4" style="height:250px">
                        <div>
                            <input type="file" id="file-input-watchlist-account" style="display: none">
                            <button class="button fds-background-dark mt-4 mb-4" id="upload-button-watchlist-account">
                                <i class="fas fa-upload mr-2"></i>
                                Watchlist Account
                            </button>
                        </div>
                        <table id="table-watchlist-account" class="table is-fullwidth"
                            style="background: rgba(255,255,255,0);">
                            <thead>
                                <tr>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div style="width: 100%;">
                    <p class="panel-heading has-text-white" style="background: #054468">Watchlist Card</p>
                    <div class="container-param mb-4" style="height:250px">
                        <div>
                            <input type="file" id="file-input-watchlist-card" style="display: none">
                            <button class="button fds-background-dark mt-4 mb-4" id="upload-button-watchlist-card">
                                <i class="fas fa-upload mr-2"></i>
                                Watchlist Card
                            </button>
                        </div>
                        <table id="table-watchlist-card" class="table is-fullwidth"
                            style="background: rgba(255,255,255,0);">
                            <thead>
                                <tr>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between;">
                <div style="width: 100%; margin-right: 10px;">
                    <p class="panel-heading has-text-white" style="background: #054468">Blacklist Account</p>
                    <div class="container-param mb-4" style="height:250px">
                        <div>
                            <input type="file" id="file-input-blacklist-account" style="display: none">
                            <button class="button fds-background-dark mt-4 mb-4" id="upload-button-blacklist-account">
                                <i class="fas fa-upload mr-2"></i>
                                Blacklist Account
                            </button>
                        </div>
                        <table id="table-blacklist-account" class="table is-fullwidth"
                            style="background: rgba(255,255,255,0);">
                            <thead>
                                <tr>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div style="width: 100%;">
                    <p class="panel-heading has-text-white" style="background: #054468">Blacklist Card</p>
                    <div class="container-param mb-4" style="height:250px">
                        <div>
                            <input type="file" id="file-input-blacklist-card" style="display: none">
                            <button class="button fds-background-dark mt-4 mb-4" id="upload-button-blacklist-card">
                                <i class="fas fa-upload mr-2"></i>
                                Blacklist Card
                            </button>
                        </div>
                        <table id="table-blacklist-card" class="table is-fullwidth"
                            style="background: rgba(255,255,255,0);">
                            <thead>
                                <tr>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between;">
                <div style="width: 100%; margin-right: 10px;">
                    <p class="panel-heading has-text-white" style="background: #054468">Dormant Account</p>
                    <div class="container-param mb-4" style="height:250px">
                        <div>
                            <input type="file" id="file-input-dormant-account" style="display: none">
                            <button class="button fds-background-dark mt-4 mb-4" id="upload-button-dormant-account">
                                <i class="fas fa-upload mr-2"></i>
                                Dormant Account
                            </button>
                        </div>
                        <table id="table-dormant-account" class="table is-fullwidth"
                            style="background: rgba(255,255,255,0);">
                            <thead>
                                <tr>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div style="width: 100%;">
                    <p class="panel-heading has-text-white" style="background: #054468">Terrorist</p>
                    <div class="container-param mb-4" style="height:250px">
                        <div id="output"></div>
                        <div>
                            <input type="file" id="file-input-terrorist" style="display: none">
                            <button class="button fds-background-dark mt-4 mb-4" id="upload-button-terrorist">
                                <i class="fas fa-upload mr-2"></i>
                                Terrorist Name
                            </button>
                        </div>
                        <table id="table-terrorist" class="table is-fullwidth" style="background: rgba(255,255,255,0);">
                            <thead>
                                <tr>
                                    <th>Value</th>
                                    <th>Birth</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>


        </div>
    </div>
    <script>
        var protocol = location.protocol;
        var slashes = protocol.concat("//");
        var host = slashes.concat(window.location.host);

        // or as you probably should do
        var host = location.protocol.concat("//").concat(window.location.host);
        var BASE_URL = host + "/backend/3000/";
        // Fungsi untuk melakukan ekstraksi teks dari PDF
        async function extractTextFromPDF(file) {
            // Membaca file PDF
            const data = new Uint8Array(await file.arrayBuffer());

            // Memuat dokumen PDF
            const pdf = await pdfjsLib.getDocument(data).promise;

            // Inisialisasi variabel untuk menyimpan teks dari semua halaman
            let extractedText = '';

            // Loop melalui semua halaman PDF
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                // Mendapatkan halaman PDF
                const page = await pdf.getPage(pageNum);

                // Mendapatkan konten teks dari halaman
                const content = await page.getTextContent();

                // Menggabungkan teks dari setiap elemen konten
                const pageText = content.items.map(item => item.str).join(' ');

                // Menambahkan teks halaman ke teks yang diekstraksi
                extractedText += pageText;
            }

            // Mengembalikan teks yang diekstraksi
            return extractedText;
        }

        // Fungsi untuk menangani klik tombol "Ekstrak Teks"
        function extractText() {
            const fileInput = document.getElementById('file-input-terrorist');
            const file = fileInput.files[0];

            if (file) {
                extractTextFromPDF(file)
                    .then(text => {

                    })
                    .catch(error => {
                        console.error('Terjadi kesalahan:', error);
                    });
            }
        }

        function breakLongLines(text, maxLength) {
            if (text === null)
                return '';

            var regex = new RegExp(`.{1,${maxLength}}`, 'g');
            var formattedText = text.replace(regex, '$&<br>');
            return formattedText;
        }

        function loadParamSystem() {
            var data = {
                user_name: sessionStorage.getItem("user_name"),
                action: 'get_parameter_system'
            };

            $.post("/backend/fds/", JSON.stringify(data),
                function (response) {
                    var trx_response = $.parseJSON(response);

                    $("#table-parameter-system tbody tr td").remove();

                    for (i = 0; i < trx_response.param_name.length; i++) {
                        let param_val = trx_response.value[i];
                        param_val = breakLongLines(param_val, 48);

                        $('<tr>').append(
                            $('<td>').html('<span class="parameter" style="width:100px">' + trx_response
                                .param_name[i] + '</span>'),
                            $('<td class="is-family-monospace">').html(param_val),
                            $('<td>').html(trx_response.description[i]),
                        ).appendTo('#table-parameter-system');
                    }
                });
        }

        function loadParamTransaction() {
            var data = {
                user_name: sessionStorage.getItem("user_name"),
                action: 'get_parameter_transaction'
            };

            $.post("/backend/fds/", JSON.stringify(data),
                function (response) {
                    var trx_response = $.parseJSON(response);

                    $("#table-parameter-transaction tbody tr td").remove();

                    for (i = 0; i < trx_response.param_name.length; i++) {
                        $('<tr>').append(
                            $('<td>').text(trx_response.param_name[i]),
                            $('<td>').text(trx_response.description[i]),
                        ).appendTo('#table-parameter-transaction');
                    }
                });
        }

        function uploadFile(event, param_name) {
            let file = event.target.files[0];
            var value = [];
            var terrorist_birth = [];
            if (file) {

                let reader = new FileReader();
                reader.onload = function (e) {
                let fileContent = String(e.target.result).split("\n");

                    if (param_name == 'TERRORIST_LIST_NAMES') {
                        fileContent.map((item, index) => {
                            let split = item.split(" ");
                            birth = split[split.length - 1];
                            terrorist_birth.unshift(birth)

                            value.unshift(fileContent[index].replace(" " + birth, ""))
                        });
                    } else {
                        fileContent = fileContent.map(item => item.replace("\r", ""));
                        fileContent.map(item => value.unshift(item.replace(" ", "")));
                    }

                    let data = {
                        value: value,
                        category: param_name,
                        terrorist_birth
                    };

                    $.ajax({
                        url: BASE_URL + 'watchlists',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(data),
                        success: function (data) {
                            alert('Upload data berhasil');
                            loadWatchlists();
                            location.reload();
                        },
                        error: function (err) {
                            console.log('Error:', err);
                        }
                    });
                };
                reader.readAsText(file);
            }
        }

        function loadOpcode() {
            $.get(BASE_URL + 'opcode', function (response) {
                $("#table-opcode tbody tr").remove();
                response.forEach((item, index) => {
                    $('<tr>').append(
                        $('<td>').text(item.code),
                        $('<td>').text(item.type),
                        $('<td>').text(item.description)
                    ).appendTo('#table-opcode');
                });
            });
        }

        function loadWatchlists() {
            $.get(BASE_URL + 'watchlists', function (response) {
                $("#table-watchlist-account tbody tr").remove();
                $("#table-watchlist-card tbody tr").remove();
                $("#table-blacklist-account tbody tr").remove();
                $("#table-blacklist-card tbody tr").remove();
                $("#table-terorrist tbody tr").remove();

                response.forEach((item, index) => {
                    if (item.category == 'DORMANT_ACCOUNT') {
                        $('<tr>').append(
                            $('<td>').text(item.value)
                        ).appendTo('#table-dormant-account');
                    }
                    if (item.category == 'WATCHLIST_ACCOUNT') {
                        $('<tr>').append(
                            $('<td>').text(item.value)
                        ).appendTo('#table-watchlist-account');
                    }
                    if (item.category == 'WATCHLIST_CARD') {
                        $('<tr>').append(
                            $('<td>').text(item.value)
                        ).appendTo('#table-watchlist-card');
                    }
                    if (item.category == 'BLACKLIST_ACCOUNT') {
                        $('<tr>').append(
                            $('<td>').text(item.value)
                        ).appendTo('#table-blacklist-account');
                    }
                    if (item.category == 'BLACKLIST_CARD') {
                        $('<tr>').append(
                            $('<td>').text(item.value)
                        ).appendTo('#table-blacklist-card');
                    }
                    if (item.category == 'TERRORIST_LIST_NAMES') {
                        $('<tr>').append(
                            $('<td>').text(item.value),
                            $('<td>').text(item.terrorist_birth ? item.terrorist_birth.split("T")[0] : '-')
                        ).appendTo('#table-terrorist');
                    }


                });
            });
        }

        $(document).ready(function () {
            $('#sidemenu').load('sidemenu.html');
            const url =
                'https://raw.githubusercontent.com/mozilla/pdf.js/ba2edeae/web/compressed.tracemonkey-pldi-09.pdf';

            loadParamSystem();
            loadParamTransaction();
            loadOpcode();
            loadWatchlists();

            var current_date = getCurrentDateTime().substring(0, 10);
            $("#start_date").val(current_date);
            $("#end_date").val(current_date);

            $(".modal_close").click(function () {
                $("#modal-edit-parameter").removeClass("is-active");
            });

            $("#button_save_parameter").click(function () {
                var data = {
                    user_name: sessionStorage.getItem("user_name"),
                    action: 'update_parameter',
                    param_name: $("#param_name").val(),
                    param_value: $("#param_value").val()
                };

                $.post("/backend/fds/", JSON.stringify(data),
                    function () {
                        loadParamSystem();
                        $("#modal-edit-parameter").removeClass("is-active");
                    });
            });

            $(document).on('click', '.parameter', function () {
                var selected_param = $(this).closest('tr').find('td:eq(0)').text();

                var data = {
                    user_name: sessionStorage.getItem("user_name"),
                    action: 'get_parameter',
                    param_name: selected_param
                };

                $.post("/backend/fds/", JSON.stringify(data),
                    function (response) {
                        $("#param_name").val(selected_param);
                        $("#param_value").val(response);
                    });

                $("#modal-edit-parameter").addClass("is-active");
            });

            $('#upload-button-dormant-account').click(function () {
                $('#file-input-dormant-account').click();
            });

            $('#upload-button-watchlist-account').click(function () {
                $('#file-input-watchlist-account').click();
            });

            $('#upload-button-watchlist-card').click(function () {
                $('#file-input-watchlist-card').click();
            });

            $('#upload-button-blacklist-card').click(function () {
                $('#file-input-blacklist-card').click();
            });

            $('#upload-button-blacklist-account').click(function () {
                $('#file-input-blacklist-account').click();
            });

            $('#upload-button-terrorist').click(function () {
                $('#file-input-terrorist').click();
            });

            $('#file-input-watchlist-card').change(function (event) {
                uploadFile(event, 'WATCHLIST_CARD');
            });

            $('#file-input-dormant-account').change(function (event) {
                uploadFile(event, 'DORMANT_ACCOUNT');
            });

            $('#file-input-watchlist-account').change(function (event) {
                uploadFile(event, 'WATCHLIST_ACCOUNT');
            });

            $('#file-input-blacklist-card').change(function (event) {
                uploadFile(event, 'BLACKLIST_CARD');
            });

            $('#file-input-blacklist-account').change(function (event) {
                uploadFile(event, 'BLACKLIST_ACCOUNT');
            });

            $('#file-input-terrorist').change(function (event) {
                uploadFile(event, 'TERRORIST_LIST_NAMES');
            });
        });
    </script>
</body>

</html>